<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Статистика тренувань - {{ user.name }}</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --stress-color: #FFD700;
            --hardness-color: #FF0000;
            --sleep-color: #9370DB;
            --feelings-color: #00FF00;
            --weight-color: #00BFFF;
            --background-color: #E6E9F0;
            --card-background: #FFFFFF;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.1);
            --border-radius: 20px;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stats-card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        
        .card-header {
            padding: 15px;
            color: white;
            text-align: center;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 18px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .stress {
            background-color: var(--stress-color);
            color: black;
        }
        
        .hardness {
            background-color: var(--hardness-color);
        }
        
        .sleep {
            background-color: var(--sleep-color);
        }
        
        .feelings {
            background-color: var(--feelings-color);
            color: black;
        }
        
        .weight {
            background-color: var(--weight-color);
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Статистика тренувань - {{ user.name }}</h1>
        <p>Період: {{ period.type }} ({{ period.start_date }} - {{ period.end_date }})</p>
        
        <div class="stats-grid" id="statsGrid">
            <!-- Стрес -->
            <div class="stats-card">
                <div class="card-header stress">
                    <h2>СТРЕС</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="stressChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Складність -->
            <div class="stats-card">
                <div class="card-header hardness">
                    <h2>СКЛАДНІСТЬ</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="hardnessChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Сон -->
            <div class="stats-card">
                <div class="card-header sleep">
                    <h2>СОН</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="sleepChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Самопочуття -->
            <div class="stats-card">
                <div class="card-header feelings">
                    <h2>САМОПОЧУТТЯ</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="feelingsChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Вага (якщо є дані) -->
            {% if weight_data and weight_data.dates|length > 0 %}
            <div class="stats-card">
                <div class="card-header weight">
                    <h2>ВАГА</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // Helper function for tooltips
        function label(context) {
            return context.dataset.label + ': ' + context.raw;
        }

        // Set default Chart.js options
        Chart.defaults.font.family = "'Arial', sans-serif";
        Chart.defaults.font.size = 14;
        Chart.defaults.plugins.tooltip = {
            backgroundColor: 'rgba(0,0,0,0.7)',
            titleFont: {
                size: 14
            },
            bodyFont: {
                size: 14
            },
            padding: 10,
            cornerRadius: 5,
            displayColors: false
        };
        
        Chart.defaults.elements.line = {
            tension: 0.3,
            borderWidth: 3,
            fill: false
        };
        
        Chart.defaults.elements.point = {
            radius: 5,
            hoverRadius: 7,
            hitRadius: 10
        };
        
        // Create stress chart (line chart)
        const stressCtx = document.getElementById('stressChart').getContext('2d');
        console.log("Creating stress chart with data:", sampleData.dates, sampleData.stress.values);
        
        new Chart(stressCtx, {
            type: 'line',
            data: {
                labels: sampleData.dates,
                datasets: [{
                    label: 'Рівень стресу',
                    data: sampleData.stress.values,
                    borderColor: sampleData.stress.color,
                    backgroundColor: sampleData.stress.color,
                    pointBackgroundColor: sampleData.stress.color,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        },
                        title: {
                            display: true,
                            text: 'Рівень стресу (1-10)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: label
                        }
                    }
                }
            }
        });
        
        // Function to draw background for hardness chart
        function beforeDraw(chart) {
            const ctx = chart.ctx;
            const chartArea = chart.chartArea;
            const meta = chart.getDatasetMeta(0);
            
            // Only draw if we have valid data points
            if (meta.data.length > 0) {
                // Draw soreness markers
                if (sampleData.soreness_markers) {
                    for (let i = 0; i < meta.data.length; i++) {
                        // Check if this date has soreness
                        if (sampleData.soreness_markers[i]) {
                            const point = meta.data[i];
                            const x = point.x;
                            const y = point.y;
                            
                            // Draw soreness indicator (circle with border)
                            ctx.beginPath();
                            ctx.arc(x, y, 8, 0, 2 * Math.PI);
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                            ctx.fill();
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = '#FF00FF'; // Magenta for soreness
                            ctx.stroke();
                        }
                    }
                }
            }
        };

        // Create hardness chart (line chart)
        const hardnessCtx = document.getElementById('hardnessChart').getContext('2d');
        console.log("Creating hardness chart with data:", sampleData.dates, sampleData.hardness.values);
        
        new Chart(hardnessCtx, {
            type: 'line',
            data: {
                labels: sampleData.dates,
                datasets: [{
                    label: 'Складність тренування',
                    data: sampleData.hardness.values,
                    borderColor: sampleData.hardness.color,
                    backgroundColor: sampleData.hardness.color,
                    pointBackgroundColor: sampleData.hardness.color,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        },
                        title: {
                            display: true,
                            text: 'Складність (1-10)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label + ': ' + context.raw;
                                const index = context.dataIndex;
                                if (sampleData.soreness_markers && sampleData.soreness_markers[index]) {
                                    return [label, 'Крепатура: Так'];
                                }
                                return label;
                            }
                        }
                    }
                }
            },
            plugins: [{
                beforeDraw: beforeDraw
            }]
        });

        // Create sleep chart (bar chart)
        const sleepCtx = document.getElementById('sleepChart').getContext('2d');
        console.log("Creating sleep chart with data:", sampleData.dates, sampleData.sleep.values);
        
        new Chart(sleepCtx, {
            type: 'bar',
            data: {
                labels: sampleData.dates,
                datasets: [{
                    label: 'Години сну',
                    data: sampleData.sleep.values,
                    backgroundColor: sampleData.sleep.color,
                    borderColor: sampleData.sleep.color,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 12,
                        ticks: {
                            stepSize: 2
                        },
                        title: {
                            display: true,
                            text: 'Години'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: label
                        }
                    }
                }
            }
        });
        
        // Create feelings chart (line chart)
        const feelingsCtx = document.getElementById('feelingsChart').getContext('2d');
        console.log("Creating feelings chart with data:", sampleData.dates, sampleData.feelings.values);
        
        new Chart(feelingsCtx, {
            type: 'line',
            data: {
                labels: sampleData.dates,
                datasets: [{
                    label: 'Самопочуття',
                    data: sampleData.feelings.values,
                    borderColor: sampleData.feelings.color,
                    backgroundColor: sampleData.feelings.color,
                    pointBackgroundColor: sampleData.feelings.color,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        },
                        title: {
                            display: true,
                            text: 'Самопочуття (1-10)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: label
                        }
                    }
                }
            }
        });
        
        // Create weight chart if data is available
        if (sampleData.weight && sampleData.weight.values && sampleData.weight.values.length > 0) {
            const weightCtx = document.getElementById('weightChart').getContext('2d');
            console.log("Creating weight chart with data:", sampleData.dates, sampleData.weight.values);
            
            new Chart(weightCtx, {
                type: 'line',
                data: {
                    labels: sampleData.dates,
                    datasets: [{
                        label: 'Вага',
                        data: sampleData.weight.values,
                        borderColor: sampleData.weight.color,
                        backgroundColor: sampleData.weight.color,
                        pointBackgroundColor: sampleData.weight.color,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Вага (кг)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: label
                            }
                        }
                    }
                }
            });
        } else {
            console.log("No weight data available");
        }

        // Helper function to draw rounded rectangles
        function drawRoundedRect(ctx, x, y, width, height, radius, color) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
        }
    </script>
</body>
</html>
